input {
  # Entrada desde Filebeat
  beats {
    port => 5044
    type => "beats"
  }

  tcp {
    port => 5000
    type => "syslog"
  }

  udp {
    port => 5000
    type => "syslog"
  }

  file {
    path => "/var/log/syslog-ng/**/*.log"
    start_position => "beginning"
    sincedb_path => "/usr/share/logstash/data/sincedb"
    type => "syslog-file"
  }
}

filter {
  if [message] =~ /Failed password/ {
    mutate {
      add_tag => [ "ssh_failed_login", "security_event" ]
      add_field => { "event_type" => "SSH Failed Authentication" }
      add_field => { "severity" => "medium" }
    }
  }

  if [message] =~ /SELECT|UNION|' OR '1'='1/ {
    mutate {
      add_tag => [ "sql_injection", "security_event" ]
      add_field => { "event_type" => "SQL Injection Attempt" }
      add_field => { "severity" => "high" }
    }
  }

  if [message] =~ /<script|javascript:|onerror=/ {
    mutate {
      add_tag => [ "xss_attack", "security_event" ]
      add_field => { "event_type" => "XSS Attack Attempt" }
      add_field => { "severity" => "high" }
    }
  }

  if [message] =~ /\.\.\/|\.\.\\|\/etc\/passwd|\/etc\/shadow/ {
    mutate {
      add_tag => [ "path_traversal", "security_event" ]
      add_field => { "event_type" => "Path Traversal Attempt" }
      add_field => { "severity" => "high" }
    }
  }

  if [message] =~ /rm -rf|mkfs|dd if=/ {
    mutate {
      add_tag => [ "destructive_command", "security_event" ]
      add_field => { "event_type" => "Destructive Command" }
      add_field => { "severity" => "critical" }
    }
  }

  if [message] =~ /changed to root|sudo su/ {
    mutate {
      add_tag => [ "privilege_escalation", "security_event" ]
      add_field => { "event_type" => "Privilege Escalation" }
      add_field => { "severity" => "critical" }
    }
  }

  if [message] =~ /Nmap scan|Discovered open port|Connection attempt|SYN packet/ {
    mutate {
      add_tag => [ "port_scan", "security_event" ]
      add_field => { "event_type" => "Port Scan" }
      add_field => { "severity" => "medium" }
    }
  }

  if [message] =~ /cryptominer|ncat|\.hidden/ {
    mutate {
      add_tag => [ "suspicious_process", "security_event" ]
      add_field => { "event_type" => "Suspicious Process" }
      add_field => { "severity" => "high" }
    }
  }

  if [message] =~ /scp|sftp|curl/ {
    mutate {
      add_tag => [ "data_exfiltration", "security_event" ]
      add_field => { "event_type" => "Data Exfiltration" }
      add_field => { "severity" => "high" }
    }
  }

  if [message] =~ /apt install|yum install|Installed:|dpkg/ {
    mutate {
      add_tag => [ "unauthorized_installation", "security_event" ]
      add_field => { "event_type" => "Unauthorized Software Installation" }
      add_field => { "severity" => "medium" }
    }
  }
}

output {
  elasticsearch {
    hosts => ["elasticsearch:9200"]
    index => "syslog-%{+YYYY.MM.dd}"
  }

  stdout {
    codec => rubydebug
  }
}
